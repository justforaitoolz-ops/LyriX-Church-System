<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LyriX Stage</title>
    <style>
        body,
        html {
            margin: 0;
            padding: 0;
            width: 100%;
            height: 100%;
            background-color: black;
            color: white;
            font-family: sans-serif;
            overflow: hidden;
            cursor: none;
            /* Hide cursor for cleanliness */
        }

        #content {
            display: flex;
            align-items: center;
            justify-content: center;
            height: 100vh;
            text-align: center;
            padding: 40px;
            box-sizing: border-box;
            transition: opacity 0.5s ease;
        }

        .text {
            font-size: 5vw;
            /* Responsive large text */
            font-weight: bold;
            line-height: 1.4;
            white-space: pre-wrap;
        }

        .hidden {
            opacity: 0;
        }
    </style>
    <script src="http://localhost:3001/socket.io/socket.io.js"></script>
</head>

<body>
    <div id="content">
        <div id="slide-text" class="text"></div>
    </div>

    <!-- Minimalist Church Profile Watermark -->
    <div id="church-watermark"
        style="position: absolute; bottom: 15px; right: 20px; font-size: 1.5vh; color: rgba(255,255,255,0.4); font-style: italic; font-weight: 300; letter-spacing: 0.05em; transition: opacity 0.5s ease; opacity: 0; pointer-events: none; z-index: 10;">
        &copy; ChurchLyriXApp<span id="church-info"></span>
    </div>

    <script>
        const socket = io('http://localhost:3001');
        const contentDiv = document.getElementById('content');
        const slideText = document.getElementById('slide-text');
        const watermark = document.getElementById('church-watermark');
        const watermarkInfo = document.getElementById('church-info');

        socket.on('connect', () => {
            console.log('Connected to server');
        });

        // Socket.io for generic (web) clients
        socket.on('current-slide', (data) => {
            slideText.innerText = data.slide || '';
        });

        socket.on('blank-screen', (isBlack) => {
            if (isBlack) {
                contentDiv.classList.add('hidden');
                watermark.classList.add('hidden');
            } else {
                contentDiv.classList.remove('hidden');
                watermark.classList.remove('hidden');
            }
        });

        socket.on('settings-update', (settings) => {
            applySettings(settings);
        });

        // Direct IPC bindings for the LyriX Local Projector Client (Zero Latency & Crashproof)
        if (window.electron) {
            window.electron.onProjectorStateChanged((event, state) => { /* ignore */ });
        }

        // Helper function for styling
        function applySettings(settings) {
            if (settings.fontSize) slideText.style.fontSize = `${settings.fontSize}vw`;
            if (settings.isBold !== undefined) slideText.style.fontWeight = settings.isBold ? 'bold' : 'normal';

            if (settings.color) document.body.style.color = settings.color;
            if (settings.backgroundColor) {
                document.body.style.backgroundColor = settings.backgroundColor;
                // Adjust watermark color for light backgrounds
                const isLight = (settings.backgroundColor.match(/^#([0-9a-f]{6})$/i) &&
                    ((parseInt(settings.backgroundColor.substring(1, 3), 16) * 299 +
                        parseInt(settings.backgroundColor.substring(3, 5), 16) * 587 +
                        parseInt(settings.backgroundColor.substring(5, 7), 16) * 114) / 1000) > 125);
                watermark.style.color = isLight ? 'rgba(0,0,0,0.4)' : 'rgba(255,255,255,0.4)';
            }
            if (settings.backgroundImage) {
                document.body.style.backgroundImage = `url("${settings.backgroundImage}")`;
                document.body.style.backgroundSize = 'cover';
                document.body.style.backgroundPosition = 'center';
                watermark.style.color = 'rgba(255,255,255,0.6)'; // Assume dark/mixed bg needs slightly stronger white
            } else if (settings.backgroundImage === '') {
                document.body.style.backgroundImage = 'none';
            }

            if (settings.textAlign) slideText.style.textAlign = settings.textAlign;
            if (settings.fontFamily) slideText.style.fontFamily = settings.fontFamily;

            // Display Church Info
            if (settings.churchName || settings.churchPlace) {
                let infoText = '';
                if (settings.churchName) infoText += ` | ${settings.churchName}`;
                if (settings.churchPlace) infoText += ` | ${settings.churchPlace}`;
                watermarkInfo.innerText = infoText;
                watermark.style.opacity = '1';
            } else {
                // If they cleared settings but we still want just the app copyright, we leave it visible.
                watermarkInfo.innerText = '';
                watermark.style.opacity = '1';
            }
        }

        // Attach generic IPC receiver for Projector
        if (window.electron) {
            if (window.electron.onProjectorSyncSlide) {
                window.electron.onProjectorSyncSlide((event, data) => {
                    slideText.innerText = data.slide || '';
                });
            }
            if (window.electron.onProjectorSyncBlank) {
                window.electron.onProjectorSyncBlank((event, isBlack) => {
                    if (isBlack) contentDiv.classList.add('hidden');
                    else contentDiv.classList.remove('hidden');
                });
            }
            if (window.electron.onProjectorSyncSettings) {
                window.electron.onProjectorSyncSettings((event, settings) => {
                    applySettings(settings);
                });
            }
        }
    </script>
</body>

</html>